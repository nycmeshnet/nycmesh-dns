- name: Install deps
  ansible.builtin.apt:
    lock_timeout: 120
    update_cache: true
    pkg:
      - apt-transport-https
      - ca-certificates
      - dnsutils
  become: true

- name: Download gpg key
  ansible.builtin.get_url:
    url: https://pkg.labs.nic.cz/gpg
    dest: /usr/share/keyrings/cznic-labs-pkg.gpg
  become: true

- name: Add package source
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list.d/cznic-labs-knot-dns.list
    line: "deb [signed-by=/usr/share/keyrings/cznic-labs-pkg.gpg] https://pkg.labs.nic.cz/knot-dns bookworm main"
    create: true
  become: true

- name: Add knot-resolver-release
  ansible.builtin.get_url:
    url: https://secure.nic.cz/files/knot-resolver/knot-resolver-release.deb
    dest: /root/knot-resolver-release.deb
  become: true

- name: Install knot-resolver-release
  ansible.builtin.apt:
    lock_timeout: 120
    deb: /root/knot-resolver-release.deb
  become: true

- name: Install knot
  ansible.builtin.apt:
    lock_timeout: 120
    update_cache: true
    pkg:
      - knot-resolver
      - knot-dnsutils
      - knot-resolver-module-http
  become: true

- name: Knot Resolver Config
  ansible.builtin.template:
    src: ../templates/kresd.conf.j2
    dest: /etc/knot-resolver/kresd.conf
  become: true

- name: Restart and enable knot-resolver service, $CPU_CORES - 1
  ansible.builtin.service:
    name: kresd@{{ item }}
    state: restarted
    enabled: true
  loop: "{{ range(1, ansible_processor_cores) | list}}"
  become: true

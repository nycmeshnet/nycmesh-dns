-- SPDX-License-Identifier: CC0-1.0
-- vim:syntax=lua:set ts=4 sw=4:
-- Refer to manual: https://knot-resolver.readthedocs.org/en/stable/

-- Network interface configuration
net.listen('127.0.0.1', 53, { kind = 'dns' })
net.listen('127.0.0.1', 853, { kind = 'tls' })
--net.listen('127.0.0.1', 443, { kind = 'doh2' })
--net.listen('::1', 53, { kind = 'dns', freebind = true })
--net.listen('::1', 853, { kind = 'tls', freebind = true })
--net.listen('::1', 443, { kind = 'doh2' })
net.listen('127.0.0.1', 9100, {kind = 'webmgmt'})

-- INTERNAL_LISTEN_IP
net.listen('{{ INTERNAL_LISTEN_IP }}', 53, { kind = 'dns' })
net.listen('{{ INTERNAL_LISTEN_IP }}', 443, { kind = 'doh2' })

{% if EXTERNAL_LISTEN_IP != "" %}
-- EXTERNAL_LISTEN_IP
net.listen('{{ EXTERNAL_LISTEN_IP }}', 53, { kind = 'dns' })
net.listen('{{ EXTERNAL_LISTEN_IP }}', 443, { kind = 'doh2' })
{% endif %}

-- Load useful modules
modules = {
        'hints > iterate',  -- Allow loading /etc/hosts or custom root hints
        'stats',            -- Track internal statistics
        'http',             -- Stats in metrics format
        'policy',           -- Allow/deny requests
        'view',             -- Consider query sources
}

-- Mesh from mesh
view:addr('10.0.0.0/8', policy.suffix(policy.STUB('10.10.10.11'), policy.todnames({'mesh.', 'mesh.nycmesh.net.'})))
view:addr('23.158.16.0/24', policy.suffix(policy.STUB('10.10.10.11'), policy.todnames({'mesh.', 'mesh.nycmesh.net.'})))
view:addr('199.167.59.0/24', policy.suffix(policy.STUB('10.10.10.11'), policy.todnames({'mesh.', 'mesh.nycmesh.net.'})))
view:addr('199.170.132.0/24', policy.suffix(policy.STUB('10.10.10.11'), policy.todnames({'mesh.', 'mesh.nycmesh.net.'})))
view:addr('208.68.5.0/24', policy.suffix(policy.STUB('10.10.10.11'), policy.todnames({'mesh.', 'mesh.nycmesh.net.'})))

-- Allow all from mesh
view:addr('127.0.0.0/8', policy.all(policy.PASS))
view:addr('10.0.0.0/8', policy.all(policy.PASS))
view:addr('23.158.16.0/24', policy.all(policy.PASS))
view:addr('199.167.59.0/24', policy.all(policy.PASS))
view:addr('199.170.132.0/24', policy.all(policy.PASS))
view:addr('208.68.5.0/24', policy.all(policy.PASS))

-- Deny other
view:addr('0.0.0.0/0', policy.all(policy.REFUSE))


-- Cache size
cache.storage = 'lmdb:///var/cache/knot-resolver-cache'
cache.size = cache.fssize() - 1000*MB - 10*MB
